<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             targetNamespace="http://demo.com/bpm"
             xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL
                                 http://www.omg.org/spec/BPMN/20100524/MODEL/BPMN20.xsd">

    <process id="incident-management" name="Recursive Incident Management with SLA Escalation" isExecutable="true">
        <documentation>
            Complex incident management workflow with recursive escalation loops.
            Features:
            - Automatic severity-based routing
            - Time-based SLA escalation (recursive re-escalation if unresolved)
            - Multi-department handoff capability
            - Root cause analysis loop
            - Post-incident review cycle
            - Recursive retry mechanism for failed resolutions
        </documentation>

        <!-- Start Event -->
        <startEvent id="startEvent" name="Incident Reported">
            <documentation>New incident is reported by user or monitoring system</documentation>
        </startEvent>

        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="classifyIncident"/>

        <!-- Service Task: Classify Incident -->
        <scriptTask id="classifyIncident" name="Classify Incident"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var severity = execution.getVariable('severity') || 'MEDIUM';
                var category = execution.getVariable('category') || 'GENERAL';
                var retryCount = execution.getVariable('retryCount') || 0;
                var escalationLevel = execution.getVariable('escalationLevel') || 0;

                // Determine initial assignment based on severity and category
                var assignedTeam = 'it';
                var slaHours = 24;
                var requiresManagerApproval = false;

                if (severity == 'CRITICAL') {
                    slaHours = 1;
                    requiresManagerApproval = true;
                    assignedTeam = 'it';
                } else if (severity == 'HIGH') {
                    slaHours = 4;
                    requiresManagerApproval = true;
                } else if (severity == 'MEDIUM') {
                    slaHours = 8;
                } else {
                    slaHours = 24;
                }

                // Category-based team routing
                if (category == 'SECURITY') {
                    assignedTeam = 'it';
                    requiresManagerApproval = true;
                } else if (category == 'HR_SYSTEM') {
                    assignedTeam = 'hr';
                } else if (category == 'FINANCIAL') {
                    assignedTeam = 'finance';
                } else if (category == 'OPERATIONS') {
                    assignedTeam = 'operations';
                }

                execution.setVariable('assignedTeam', assignedTeam);
                execution.setVariable('slaHours', slaHours);
                execution.setVariable('requiresManagerApproval', requiresManagerApproval);
                execution.setVariable('status', 'OPEN');
                execution.setVariable('resolutionAttempts', 0);
                execution.setVariable('handoffHistory', '[]');
                execution.setVariable('escalationHistory', '[]');
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow2" sourceRef="classifyIncident" targetRef="checkCriticalSeverity"/>

        <!-- Gateway: Check if Critical -->
        <exclusiveGateway id="checkCriticalSeverity" name="Is Critical?"/>

        <sequenceFlow id="flowCritical" sourceRef="checkCriticalSeverity" targetRef="notifyManagement">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${severity == 'CRITICAL'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowNonCritical" sourceRef="checkCriticalSeverity" targetRef="initialTriage">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${severity != 'CRITICAL'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Service Task: Notify Management -->
        <scriptTask id="notifyManagement" name="Notify Management"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var notifications = execution.getVariable('notifications') || '[]';
                var notifArray = JSON.parse(notifications);
                notifArray.push({
                    type: 'CRITICAL_INCIDENT',
                    timestamp: new Date().toISOString(),
                    recipients: ['it.cto', 'ops.coo', 'exec.ceo']
                });
                execution.setVariable('notifications', JSON.stringify(notifArray));
                execution.setVariable('managementNotified', true);
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow3" sourceRef="notifyManagement" targetRef="initialTriage"/>

        <!-- User Task: Initial Triage -->
        <userTask id="initialTriage" name="Initial Incident Triage"
                  flowable:candidateGroups="${assignedTeam}"
                  flowable:formKey="incident-triage-form">
            <documentation>
                Incident: ${title}
                Severity: ${severity}
                Category: ${category}
                Description: ${description}

                Actions: Assign, Escalate, Request More Info, Mark as Duplicate
            </documentation>
        </userTask>

        <sequenceFlow id="flow4" sourceRef="initialTriage" targetRef="checkTriageDecision"/>

        <!-- Gateway: Check Triage Decision -->
        <exclusiveGateway id="checkTriageDecision" name="Triage Decision"/>

        <sequenceFlow id="flowAssigned" sourceRef="checkTriageDecision" targetRef="investigateIncident">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowEscalate" sourceRef="checkTriageDecision" targetRef="escalateIncident">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowRequestInfo" sourceRef="checkTriageDecision" targetRef="requestMoreInfo">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'request_changes'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowDuplicate" sourceRef="checkTriageDecision" targetRef="markDuplicate">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowHandoff" sourceRef="checkTriageDecision" targetRef="handoffToTeam">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'de_escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Request More Information -->
        <userTask id="requestMoreInfo" name="Provide Additional Information"
                  flowable:assignee="${reportedBy}"
                  flowable:formKey="incident-info-form">
            <documentation>
                Additional information is required for incident: ${title}
                Questions: ${infoQuestions}
            </documentation>
        </userTask>

        <sequenceFlow id="flowInfoProvided" sourceRef="requestMoreInfo" targetRef="initialTriage"/>

        <!-- Script Task: Mark as Duplicate -->
        <scriptTask id="markDuplicate" name="Mark as Duplicate"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                execution.setVariable('status', 'DUPLICATE');
                execution.setVariable('closedAt', new Date().toISOString());
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flowDuplicateClosed" sourceRef="markDuplicate" targetRef="endDuplicate"/>

        <!-- Script Task: Handoff to Different Team -->
        <scriptTask id="handoffToTeam" name="Handoff to Team"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var handoffHistory = JSON.parse(execution.getVariable('handoffHistory') || '[]');
                handoffHistory.push({
                    fromTeam: execution.getVariable('assignedTeam'),
                    toTeam: execution.getVariable('handoffTeam'),
                    timestamp: new Date().toISOString(),
                    reason: execution.getVariable('handoffReason')
                });
                execution.setVariable('handoffHistory', JSON.stringify(handoffHistory));
                execution.setVariable('assignedTeam', execution.getVariable('handoffTeam'));
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flowAfterHandoff" sourceRef="handoffToTeam" targetRef="initialTriage"/>

        <!-- Script Task: Escalate Incident -->
        <scriptTask id="escalateIncident" name="Escalate Incident"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var escalationLevel = (execution.getVariable('escalationLevel') || 0) + 1;
                var escalationHistory = JSON.parse(execution.getVariable('escalationHistory') || '[]');

                escalationHistory.push({
                    level: escalationLevel,
                    timestamp: new Date().toISOString(),
                    reason: execution.getVariable('escalationReason'),
                    escalatedBy: execution.getVariable('escalatedBy')
                });

                // Determine new assignment based on escalation level
                var newAssignment = 'supervisors';
                if (escalationLevel >= 3) {
                    newAssignment = 'executives';
                } else if (escalationLevel >= 2) {
                    newAssignment = 'directors';
                } else if (escalationLevel >= 1) {
                    newAssignment = 'managers';
                }

                execution.setVariable('escalationLevel', escalationLevel);
                execution.setVariable('escalationHistory', JSON.stringify(escalationHistory));
                execution.setVariable('currentEscalationGroup', newAssignment);
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow5" sourceRef="escalateIncident" targetRef="escalatedReview"/>

        <!-- User Task: Escalated Review -->
        <userTask id="escalatedReview" name="Escalated Incident Review"
                  flowable:candidateGroups="${currentEscalationGroup}"
                  flowable:formKey="incident-escalation-form">
            <documentation>
                ESCALATED INCIDENT - Level ${escalationLevel}
                Incident: ${title}
                Severity: ${severity}
                Escalation History: ${escalationHistory}

                Actions: Take Ownership, Escalate Further, De-escalate, Assign Resources
            </documentation>
        </userTask>

        <sequenceFlow id="flow6" sourceRef="escalatedReview" targetRef="checkEscalatedDecision"/>

        <!-- Gateway: Check Escalated Decision -->
        <exclusiveGateway id="checkEscalatedDecision" name="Escalated Decision"/>

        <sequenceFlow id="flowTakeOwnership" sourceRef="checkEscalatedDecision" targetRef="investigateIncident">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowEscalateFurther" sourceRef="checkEscalatedDecision" targetRef="checkMaxEscalation">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowDeEscalate" sourceRef="checkEscalatedDecision" targetRef="initialTriage">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'de_escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Gateway: Check Max Escalation -->
        <exclusiveGateway id="checkMaxEscalation" name="Max Escalation?"/>

        <sequenceFlow id="flowCanEscalate" sourceRef="checkMaxEscalation" targetRef="escalateIncident">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${escalationLevel < 3}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowMaxEscalation" sourceRef="checkMaxEscalation" targetRef="executiveIntervention">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${escalationLevel >= 3}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Executive Intervention -->
        <userTask id="executiveIntervention" name="Executive Intervention Required"
                  flowable:candidateGroups="executives"
                  flowable:formKey="incident-executive-form">
            <documentation>
                MAXIMUM ESCALATION REACHED
                This incident requires executive intervention.

                Incident: ${title}
                Severity: ${severity}
                Full Escalation History: ${escalationHistory}

                Actions: Assign Special Task Force, External Vendor, Accept Risk
            </documentation>
        </userTask>

        <sequenceFlow id="flow7" sourceRef="executiveIntervention" targetRef="investigateIncident"/>

        <!-- User Task: Investigate Incident -->
        <userTask id="investigateIncident" name="Investigate and Resolve Incident"
                  flowable:candidateGroups="${assignedTeam}"
                  flowable:formKey="incident-investigation-form">
            <documentation>
                Incident: ${title}
                Severity: ${severity}
                Status: ${status}

                Actions: Resolve, Request Expert Help, Escalate, Apply Workaround
            </documentation>
        </userTask>

        <sequenceFlow id="flow8" sourceRef="investigateIncident" targetRef="updateResolutionAttempts"/>

        <!-- Script Task: Update Resolution Attempts -->
        <scriptTask id="updateResolutionAttempts" name="Update Resolution Attempts"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var attempts = (execution.getVariable('resolutionAttempts') || 0) + 1;
                execution.setVariable('resolutionAttempts', attempts);
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow9" sourceRef="updateResolutionAttempts" targetRef="checkResolutionDecision"/>

        <!-- Gateway: Check Resolution Decision -->
        <exclusiveGateway id="checkResolutionDecision" name="Resolution Decision"/>

        <sequenceFlow id="flowResolved" sourceRef="checkResolutionDecision" targetRef="checkNeedsRCA">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowWorkaround" sourceRef="checkResolutionDecision" targetRef="applyWorkaround">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'request_changes'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowNeedsHelp" sourceRef="checkResolutionDecision" targetRef="checkRetryLimit">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'de_escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowInvestigationEscalate" sourceRef="checkResolutionDecision" targetRef="escalateIncident">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Gateway: Check Retry Limit (Recursive) -->
        <exclusiveGateway id="checkRetryLimit" name="Retry Limit Reached?"/>

        <sequenceFlow id="flowCanRetry" sourceRef="checkRetryLimit" targetRef="investigateIncident">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${resolutionAttempts < 3}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowRetryLimitReached" sourceRef="checkRetryLimit" targetRef="escalateIncident">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${resolutionAttempts >= 3}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Script Task: Apply Workaround -->
        <scriptTask id="applyWorkaround" name="Apply Workaround"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                execution.setVariable('status', 'WORKAROUND_APPLIED');
                execution.setVariable('workaroundAppliedAt', new Date().toISOString());
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow10" sourceRef="applyWorkaround" targetRef="schedulePermanentFix"/>

        <!-- User Task: Schedule Permanent Fix -->
        <userTask id="schedulePermanentFix" name="Schedule Permanent Fix"
                  flowable:candidateGroups="${assignedTeam}"
                  flowable:formKey="incident-fix-schedule-form">
            <documentation>
                Workaround applied. Schedule permanent fix.
                Incident: ${title}
                Workaround: ${workaroundDescription}
            </documentation>
        </userTask>

        <sequenceFlow id="flow11" sourceRef="schedulePermanentFix" targetRef="checkNeedsRCA"/>

        <!-- Gateway: Check if RCA Needed -->
        <exclusiveGateway id="checkNeedsRCA" name="Needs RCA?"/>

        <sequenceFlow id="flowNeedsRCA" sourceRef="checkNeedsRCA" targetRef="performRCA">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${severity == 'CRITICAL' || severity == 'HIGH'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowNoRCA" sourceRef="checkNeedsRCA" targetRef="closeIncident">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${severity != 'CRITICAL' && severity != 'HIGH'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Root Cause Analysis -->
        <userTask id="performRCA" name="Perform Root Cause Analysis"
                  flowable:candidateGroups="${assignedTeam}"
                  flowable:formKey="incident-rca-form">
            <documentation>
                Perform Root Cause Analysis for: ${title}

                Document:
                - Root cause
                - Contributing factors
                - Preventive measures
            </documentation>
        </userTask>

        <sequenceFlow id="flow12" sourceRef="performRCA" targetRef="checkRCAComplete"/>

        <!-- Gateway: Check RCA Complete -->
        <exclusiveGateway id="checkRCAComplete" name="RCA Complete?"/>

        <sequenceFlow id="flowRCAComplete" sourceRef="checkRCAComplete" targetRef="reviewRCA">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowRCAIncomplete" sourceRef="checkRCAComplete" targetRef="performRCA">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'request_changes'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Review RCA -->
        <userTask id="reviewRCA" name="Review Root Cause Analysis"
                  flowable:candidateGroups="managers"
                  flowable:formKey="incident-rca-review-form">
            <documentation>
                Review RCA for: ${title}

                Root Cause: ${rootCause}
                Preventive Measures: ${preventiveMeasures}

                Actions: Approve, Request Revisions, Escalate
            </documentation>
        </userTask>

        <sequenceFlow id="flow13" sourceRef="reviewRCA" targetRef="checkRCAReviewDecision"/>

        <!-- Gateway: Check RCA Review Decision -->
        <exclusiveGateway id="checkRCAReviewDecision" name="RCA Review Decision"/>

        <sequenceFlow id="flowRCAApproved" sourceRef="checkRCAReviewDecision" targetRef="closeIncident">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowRCARevisions" sourceRef="checkRCAReviewDecision" targetRef="performRCA">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'request_changes'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Script Task: Close Incident -->
        <scriptTask id="closeIncident" name="Close Incident"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                execution.setVariable('status', 'CLOSED');
                execution.setVariable('closedAt', new Date().toISOString());
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow14" sourceRef="closeIncident" targetRef="endResolved"/>

        <!-- End Events -->
        <endEvent id="endResolved" name="Incident Resolved">
            <documentation>Incident has been fully resolved and closed</documentation>
        </endEvent>

        <endEvent id="endDuplicate" name="Marked as Duplicate">
            <documentation>Incident was marked as duplicate of existing incident</documentation>
        </endEvent>

    </process>
</definitions>
