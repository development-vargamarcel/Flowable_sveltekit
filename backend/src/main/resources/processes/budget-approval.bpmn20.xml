<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             targetNamespace="http://demo.com/bpm"
             xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL
                                 http://www.omg.org/spec/BPMN/20100524/MODEL/BPMN20.xsd">

    <process id="budget-approval" name="Multi-Department Budget Approval with Parallel Reviews" isExecutable="true">
        <documentation>
            Complex multi-departmental budget approval workflow.
            Features:
            - Parallel approval paths across multiple departments
            - Conditional approval based on budget categories
            - Finance validation with recursive correction loops
            - Legal review for contracts over threshold
            - Executive board review for major budgets
            - Quarterly budget reconciliation
        </documentation>

        <!-- Start Event -->
        <startEvent id="startEvent" name="Budget Request Submitted">
            <documentation>Annual or project budget request submitted</documentation>
        </startEvent>

        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="initializeBudget"/>

        <!-- Script Task: Initialize Budget Request -->
        <scriptTask id="initializeBudget" name="Initialize Budget Request"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var totalAmount = parseFloat(execution.getVariable('totalAmount') || 0);
                var department = execution.getVariable('department') || 'GENERAL';
                var budgetType = execution.getVariable('budgetType') || 'OPERATIONAL';
                var fiscalYear = execution.getVariable('fiscalYear') || new Date().getFullYear();

                // Determine required approvals
                var requiresLegalReview = totalAmount > 50000 || budgetType == 'CONTRACT';
                var requiresBoardApproval = totalAmount > 500000;
                var requiresFinanceValidation = true;
                var requiresDepartmentApproval = true;

                // Parse budget line items
                var lineItems = execution.getVariable('lineItems') || '[]';

                execution.setVariable('requiresLegalReview', requiresLegalReview);
                execution.setVariable('requiresBoardApproval', requiresBoardApproval);
                execution.setVariable('requiresFinanceValidation', requiresFinanceValidation);
                execution.setVariable('requiresDepartmentApproval', requiresDepartmentApproval);
                execution.setVariable('status', 'PENDING_REVIEW');
                execution.setVariable('revisionCount', 0);
                execution.setVariable('approvalHistory', '[]');
                execution.setVariable('validationIssues', '[]');
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow2" sourceRef="initializeBudget" targetRef="departmentReview"/>

        <!-- User Task: Department Head Review -->
        <userTask id="departmentReview" name="Department Head Budget Review"
                  flowable:candidateGroups="managers"
                  flowable:formKey="budget-department-form">
            <documentation>
                Budget Request: ${budgetTitle}
                Department: ${department}
                Total Amount: $${totalAmount}
                Fiscal Year: ${fiscalYear}
                Type: ${budgetType}

                Review and approve department budget allocation.
                Actions: Approve, Reject, Request Modifications
            </documentation>
        </userTask>

        <sequenceFlow id="flow3" sourceRef="departmentReview" targetRef="recordDepartmentDecision"/>

        <!-- Script Task: Record Department Decision -->
        <scriptTask id="recordDepartmentDecision" name="Record Department Decision"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var history = JSON.parse(execution.getVariable('approvalHistory') || '[]');
                history.push({
                    stage: 'DEPARTMENT_REVIEW',
                    decision: execution.getVariable('departmentDecision'),
                    approver: execution.getVariable('departmentApprover'),
                    timestamp: new Date().toISOString(),
                    comments: execution.getVariable('departmentComments')
                });
                execution.setVariable('approvalHistory', JSON.stringify(history));
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow4" sourceRef="recordDepartmentDecision" targetRef="checkDepartmentDecision"/>

        <!-- Gateway: Check Department Decision -->
        <exclusiveGateway id="checkDepartmentDecision" name="Department Decision"/>

        <sequenceFlow id="flowDeptApproved" sourceRef="checkDepartmentDecision" targetRef="parallelReviewGateway">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${departmentDecision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowDeptRejected" sourceRef="checkDepartmentDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${departmentDecision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowDeptModify" sourceRef="checkDepartmentDecision" targetRef="modifyBudget">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${departmentDecision == 'modify'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Modify Budget (Recursive) -->
        <userTask id="modifyBudget" name="Revise Budget Request"
                  flowable:assignee="${initiator}"
                  flowable:formKey="budget-revision-form">
            <documentation>
                Please revise the budget based on feedback:
                ${departmentComments}

                Revision #${revisionCount + 1}
            </documentation>
        </userTask>

        <sequenceFlow id="flow5" sourceRef="modifyBudget" targetRef="updateRevisionCount"/>

        <!-- Script Task: Update Revision Count -->
        <scriptTask id="updateRevisionCount" name="Update Revision Count"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var count = (execution.getVariable('revisionCount') || 0) + 1;
                execution.setVariable('revisionCount', count);
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow6" sourceRef="updateRevisionCount" targetRef="checkMaxRevisions"/>

        <!-- Gateway: Check Max Revisions -->
        <exclusiveGateway id="checkMaxRevisions" name="Max Revisions?"/>

        <sequenceFlow id="flowCanRevise" sourceRef="checkMaxRevisions" targetRef="departmentReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${revisionCount < 5}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowMaxRevisions" sourceRef="checkMaxRevisions" targetRef="escalateToDirector">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${revisionCount >= 5}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Escalate to Director -->
        <userTask id="escalateToDirector" name="Director Intervention - Budget Stalled"
                  flowable:candidateGroups="directors"
                  flowable:formKey="budget-escalation-form">
            <documentation>
                Budget request has exceeded revision limit.
                Revisions: ${revisionCount}

                Please intervene and make final decision.
            </documentation>
        </userTask>

        <sequenceFlow id="flow7" sourceRef="escalateToDirector" targetRef="checkDirectorIntervention"/>

        <!-- Gateway: Check Director Intervention -->
        <exclusiveGateway id="checkDirectorIntervention" name="Director Decision"/>

        <sequenceFlow id="flowDirectorApprove" sourceRef="checkDirectorIntervention" targetRef="parallelReviewGateway">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${directorDecision == 'force_approve'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowDirectorReject" sourceRef="checkDirectorIntervention" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${directorDecision == 'reject'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Parallel Gateway: Start Parallel Reviews -->
        <parallelGateway id="parallelReviewGateway" name="Start Parallel Reviews"/>

        <sequenceFlow id="flowToFinance" sourceRef="parallelReviewGateway" targetRef="financeValidation"/>
        <sequenceFlow id="flowToLegalCheck" sourceRef="parallelReviewGateway" targetRef="checkLegalRequired"/>
        <sequenceFlow id="flowToOpsReview" sourceRef="parallelReviewGateway" targetRef="operationsReview"/>

        <!-- User Task: Finance Validation -->
        <userTask id="financeValidation" name="Finance Validation"
                  flowable:candidateGroups="finance"
                  flowable:formKey="budget-finance-form">
            <documentation>
                Validate budget for: ${budgetTitle}
                Total: $${totalAmount}
                Department: ${department}

                Check:
                - Budget codes accuracy
                - Available funds
                - Compliance with fiscal policies
                - Cost allocation correctness
            </documentation>
        </userTask>

        <sequenceFlow id="flow8" sourceRef="financeValidation" targetRef="checkFinanceValidation"/>

        <!-- Gateway: Check Finance Validation -->
        <exclusiveGateway id="checkFinanceValidation" name="Finance Decision"/>

        <sequenceFlow id="flowFinanceValid" sourceRef="checkFinanceValidation" targetRef="financeApproved">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${financeDecision == 'validated'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowFinanceIssues" sourceRef="checkFinanceValidation" targetRef="addressFinanceIssues">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${financeDecision == 'issues_found'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Address Finance Issues (Recursive) -->
        <userTask id="addressFinanceIssues" name="Address Finance Issues"
                  flowable:assignee="${initiator}"
                  flowable:formKey="budget-finance-issues-form">
            <documentation>
                Finance has identified issues:
                ${financeIssues}

                Please correct and resubmit.
            </documentation>
        </userTask>

        <sequenceFlow id="flow9" sourceRef="addressFinanceIssues" targetRef="financeValidation"/>

        <!-- Intermediate Event: Finance Approved -->
        <intermediateCatchEvent id="financeApproved" name="Finance Approved">
            <documentation>Finance validation completed successfully</documentation>
            <timerEventDefinition>
                <timeDuration>PT0S</timeDuration>
            </timerEventDefinition>
        </intermediateCatchEvent>

        <sequenceFlow id="flowFinanceToJoin" sourceRef="financeApproved" targetRef="parallelJoinGateway"/>

        <!-- Gateway: Check Legal Required -->
        <exclusiveGateway id="checkLegalRequired" name="Legal Required?"/>

        <sequenceFlow id="flowLegalRequired" sourceRef="checkLegalRequired" targetRef="legalReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresLegalReview == true}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowLegalNotRequired" sourceRef="checkLegalRequired" targetRef="legalSkipped">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresLegalReview == false}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Legal Review -->
        <userTask id="legalReview" name="Legal Contract Review"
                  flowable:candidateGroups="legal"
                  flowable:formKey="budget-legal-form">
            <documentation>
                Review budget for legal compliance:
                ${budgetTitle}
                Amount: $${totalAmount}

                Check:
                - Contract terms
                - Vendor agreements
                - Regulatory compliance
                - Risk assessment
            </documentation>
        </userTask>

        <sequenceFlow id="flow10" sourceRef="legalReview" targetRef="checkLegalDecision"/>

        <!-- Gateway: Check Legal Decision -->
        <exclusiveGateway id="checkLegalDecision" name="Legal Decision"/>

        <sequenceFlow id="flowLegalApproved" sourceRef="checkLegalDecision" targetRef="legalComplete">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${legalDecision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowLegalRevisions" sourceRef="checkLegalDecision" targetRef="addressLegalConcerns">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${legalDecision == 'revisions_required'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowLegalRejected" sourceRef="checkLegalDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${legalDecision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Address Legal Concerns (Recursive) -->
        <userTask id="addressLegalConcerns" name="Address Legal Concerns"
                  flowable:assignee="${initiator}"
                  flowable:formKey="budget-legal-concerns-form">
            <documentation>
                Legal has raised concerns:
                ${legalConcerns}

                Please address and resubmit.
            </documentation>
        </userTask>

        <sequenceFlow id="flow11" sourceRef="addressLegalConcerns" targetRef="legalReview"/>

        <!-- Intermediate Event: Legal Complete -->
        <intermediateCatchEvent id="legalComplete" name="Legal Complete">
            <timerEventDefinition>
                <timeDuration>PT0S</timeDuration>
            </timerEventDefinition>
        </intermediateCatchEvent>

        <sequenceFlow id="flowLegalToJoin" sourceRef="legalComplete" targetRef="parallelJoinGateway"/>

        <!-- Intermediate Event: Legal Skipped -->
        <intermediateCatchEvent id="legalSkipped" name="Legal Not Required">
            <timerEventDefinition>
                <timeDuration>PT0S</timeDuration>
            </timerEventDefinition>
        </intermediateCatchEvent>

        <sequenceFlow id="flowSkippedToJoin" sourceRef="legalSkipped" targetRef="parallelJoinGateway"/>

        <!-- User Task: Operations Review -->
        <userTask id="operationsReview" name="Operations Impact Review"
                  flowable:candidateGroups="operations"
                  flowable:formKey="budget-ops-form">
            <documentation>
                Review operational impact:
                ${budgetTitle}
                Department: ${department}

                Assess:
                - Resource requirements
                - Timeline feasibility
                - Operational risks
            </documentation>
        </userTask>

        <sequenceFlow id="flow12" sourceRef="operationsReview" targetRef="parallelJoinGateway"/>

        <!-- Parallel Gateway: Join All Reviews -->
        <parallelGateway id="parallelJoinGateway" name="Join Reviews"/>

        <sequenceFlow id="flow13" sourceRef="parallelJoinGateway" targetRef="checkBoardRequired"/>

        <!-- Gateway: Check Board Approval Required -->
        <exclusiveGateway id="checkBoardRequired" name="Board Required?"/>

        <sequenceFlow id="flowBoardRequired" sourceRef="checkBoardRequired" targetRef="cfoReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresBoardApproval == true}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowBoardNotRequired" sourceRef="checkBoardRequired" targetRef="finalApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresBoardApproval == false}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: CFO Review -->
        <userTask id="cfoReview" name="CFO Pre-Board Review"
                  flowable:candidateGroups="directors"
                  flowable:formKey="budget-cfo-form">
            <documentation>
                Pre-board review for: ${budgetTitle}
                Total: $${totalAmount}

                Prepare board presentation and recommendation.
            </documentation>
        </userTask>

        <sequenceFlow id="flow14" sourceRef="cfoReview" targetRef="boardApproval"/>

        <!-- User Task: Executive Board Approval -->
        <userTask id="boardApproval" name="Executive Board Approval"
                  flowable:candidateGroups="executives"
                  flowable:formKey="budget-board-form">
            <documentation>
                BOARD APPROVAL REQUIRED
                Budget: ${budgetTitle}
                Amount: $${totalAmount}
                CFO Recommendation: ${cfoRecommendation}

                This is a major budget requiring executive board approval.
            </documentation>
        </userTask>

        <sequenceFlow id="flow15" sourceRef="boardApproval" targetRef="checkBoardDecision"/>

        <!-- Gateway: Check Board Decision -->
        <exclusiveGateway id="checkBoardDecision" name="Board Decision"/>

        <sequenceFlow id="flowBoardApproved" sourceRef="checkBoardDecision" targetRef="finalApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${boardDecision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowBoardConditional" sourceRef="checkBoardDecision" targetRef="addressBoardConditions">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${boardDecision == 'conditional'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowBoardRejected" sourceRef="checkBoardDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${boardDecision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Address Board Conditions (Recursive) -->
        <userTask id="addressBoardConditions" name="Address Board Conditions"
                  flowable:assignee="${initiator}"
                  flowable:formKey="budget-board-conditions-form">
            <documentation>
                Board has approved with conditions:
                ${boardConditions}

                Address conditions and resubmit.
            </documentation>
        </userTask>

        <sequenceFlow id="flow16" sourceRef="addressBoardConditions" targetRef="boardApproval"/>

        <!-- Script Task: Final Approval -->
        <scriptTask id="finalApproval" name="Finalize Budget Approval"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var history = JSON.parse(execution.getVariable('approvalHistory') || '[]');
                history.push({
                    stage: 'FINAL_APPROVAL',
                    decision: 'approved',
                    timestamp: new Date().toISOString()
                });
                execution.setVariable('approvalHistory', JSON.stringify(history));
                execution.setVariable('status', 'APPROVED');
                execution.setVariable('approvedAt', new Date().toISOString());
                execution.setVariable('budgetCode', 'BUD-' + execution.getVariable('fiscalYear') + '-' + Math.floor(Math.random() * 10000));
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow17" sourceRef="finalApproval" targetRef="endApproved"/>

        <!-- End Events -->
        <endEvent id="endApproved" name="Budget Approved">
            <documentation>Budget has been fully approved and activated</documentation>
        </endEvent>

        <endEvent id="endRejected" name="Budget Rejected">
            <documentation>Budget request has been rejected</documentation>
        </endEvent>

    </process>
</definitions>
