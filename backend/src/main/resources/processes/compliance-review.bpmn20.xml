<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             targetNamespace="http://demo.com/bpm"
             xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL
                                 http://www.omg.org/spec/BPMN/20100524/MODEL/BPMN20.xsd">

    <process id="compliance-review" name="Comprehensive Compliance Review with Parallel Audits" isExecutable="true">
        <documentation>
            Comprehensive compliance review workflow for regulatory requirements.
            Features:
            - Parallel audit streams (Financial, Legal, Security, Operational)
            - Conditional branching based on compliance type
            - Recursive remediation loops with escalation
            - Risk scoring and threshold-based decisions
            - External auditor integration
            - Board certification requirement
        </documentation>

        <!-- Start Event -->
        <startEvent id="startEvent" name="Compliance Review Initiated">
            <documentation>Annual or triggered compliance review initiated</documentation>
        </startEvent>

        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="initializeReview"/>

        <!-- Script Task: Initialize Review -->
        <scriptTask id="initializeReview" name="Initialize Compliance Review"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var complianceType = execution.getVariable('complianceType') || 'ANNUAL';
                var scope = execution.getVariable('scope') || 'FULL';
                var regulatoryFramework = execution.getVariable('regulatoryFramework') || 'SOX';

                // Determine required audits based on type
                var requiresFinancialAudit = true;
                var requiresSecurityAudit = scope == 'FULL' || complianceType == 'SECURITY';
                var requiresOperationalAudit = scope == 'FULL' || complianceType == 'OPERATIONAL';
                var requiresLegalAudit = scope == 'FULL' || complianceType == 'REGULATORY';
                var requiresExternalAudit = complianceType == 'ANNUAL' || complianceType == 'REGULATORY';

                execution.setVariable('requiresFinancialAudit', requiresFinancialAudit);
                execution.setVariable('requiresSecurityAudit', requiresSecurityAudit);
                execution.setVariable('requiresOperationalAudit', requiresOperationalAudit);
                execution.setVariable('requiresLegalAudit', requiresLegalAudit);
                execution.setVariable('requiresExternalAudit', requiresExternalAudit);

                execution.setVariable('status', 'IN_PROGRESS');
                execution.setVariable('overallRiskScore', 0);
                execution.setVariable('findingsCount', 0);
                execution.setVariable('criticalFindings', 0);
                execution.setVariable('remediationCycles', 0);
                execution.setVariable('auditFindings', '[]');
                execution.setVariable('remediationPlan', '[]');
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow2" sourceRef="initializeReview" targetRef="scopeDefinition"/>

        <!-- User Task: Define Review Scope -->
        <userTask id="scopeDefinition" name="Define Review Scope"
                  flowable:candidateGroups="legal"
                  flowable:formKey="compliance-scope-form">
            <documentation>
                Define scope for: ${complianceTitle}
                Type: ${complianceType}
                Framework: ${regulatoryFramework}

                Select areas to include in this compliance review.
            </documentation>
        </userTask>

        <sequenceFlow id="flow3" sourceRef="scopeDefinition" targetRef="parallelAuditStart"/>

        <!-- Parallel Gateway: Start Parallel Audits -->
        <parallelGateway id="parallelAuditStart" name="Begin Parallel Audits"/>

        <sequenceFlow id="flowToFinancialAudit" sourceRef="parallelAuditStart" targetRef="checkFinancialRequired"/>
        <sequenceFlow id="flowToSecurityAudit" sourceRef="parallelAuditStart" targetRef="checkSecurityRequired"/>
        <sequenceFlow id="flowToOperationalAudit" sourceRef="parallelAuditStart" targetRef="checkOperationalRequired"/>
        <sequenceFlow id="flowToLegalAudit" sourceRef="parallelAuditStart" targetRef="checkLegalRequired"/>

        <!-- ===== FINANCIAL AUDIT STREAM ===== -->
        <exclusiveGateway id="checkFinancialRequired" name="Financial Audit Required?"/>

        <sequenceFlow id="flowFinancialYes" sourceRef="checkFinancialRequired" targetRef="financialAudit">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresFinancialAudit == true}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowFinancialNo" sourceRef="checkFinancialRequired" targetRef="financialSkipped">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresFinancialAudit == false}]]>
            </conditionExpression>
        </sequenceFlow>

        <userTask id="financialAudit" name="Financial Compliance Audit"
                  flowable:candidateGroups="finance"
                  flowable:formKey="compliance-financial-form">
            <documentation>
                Conduct financial compliance audit.
                Framework: ${regulatoryFramework}

                Areas to review:
                - Internal controls
                - Financial reporting accuracy
                - Asset safeguarding
                - Segregation of duties
            </documentation>
        </userTask>

        <sequenceFlow id="flow4" sourceRef="financialAudit" targetRef="recordFinancialFindings"/>

        <scriptTask id="recordFinancialFindings" name="Record Financial Findings"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var findings = JSON.parse(execution.getVariable('auditFindings') || '[]');
                var financialFindings = execution.getVariable('financialFindings') || '';
                var financialRisk = parseInt(execution.getVariable('financialRiskScore') || 0);

                if (financialFindings) {
                    findings.push({
                        area: 'FINANCIAL',
                        findings: financialFindings,
                        riskScore: financialRisk,
                        timestamp: new Date().toISOString()
                    });
                }

                var overallRisk = parseInt(execution.getVariable('overallRiskScore') || 0);
                execution.setVariable('overallRiskScore', overallRisk + financialRisk);
                execution.setVariable('auditFindings', JSON.stringify(findings));
                execution.setVariable('financialAuditComplete', true);
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flowFinancialToJoin" sourceRef="recordFinancialFindings" targetRef="parallelAuditJoin"/>

        <intermediateCatchEvent id="financialSkipped" name="Financial Skipped">
            <timerEventDefinition><timeDuration>PT0S</timeDuration></timerEventDefinition>
        </intermediateCatchEvent>

        <sequenceFlow id="flowFinancialSkipToJoin" sourceRef="financialSkipped" targetRef="parallelAuditJoin"/>

        <!-- ===== SECURITY AUDIT STREAM ===== -->
        <exclusiveGateway id="checkSecurityRequired" name="Security Audit Required?"/>

        <sequenceFlow id="flowSecurityYes" sourceRef="checkSecurityRequired" targetRef="securityAudit">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresSecurityAudit == true}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowSecurityNo" sourceRef="checkSecurityRequired" targetRef="securitySkipped">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresSecurityAudit == false}]]>
            </conditionExpression>
        </sequenceFlow>

        <userTask id="securityAudit" name="Security Compliance Audit"
                  flowable:candidateGroups="it"
                  flowable:formKey="compliance-security-form">
            <documentation>
                Conduct security compliance audit.

                Areas to review:
                - Access controls
                - Data protection
                - Network security
                - Vulnerability management
                - Incident response
            </documentation>
        </userTask>

        <sequenceFlow id="flow5" sourceRef="securityAudit" targetRef="recordSecurityFindings"/>

        <scriptTask id="recordSecurityFindings" name="Record Security Findings"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var findings = JSON.parse(execution.getVariable('auditFindings') || '[]');
                var securityFindings = execution.getVariable('securityFindings') || '';
                var securityRisk = parseInt(execution.getVariable('securityRiskScore') || 0);

                if (securityFindings) {
                    findings.push({
                        area: 'SECURITY',
                        findings: securityFindings,
                        riskScore: securityRisk,
                        timestamp: new Date().toISOString()
                    });
                }

                var overallRisk = parseInt(execution.getVariable('overallRiskScore') || 0);
                execution.setVariable('overallRiskScore', overallRisk + securityRisk);
                execution.setVariable('auditFindings', JSON.stringify(findings));
                execution.setVariable('securityAuditComplete', true);
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flowSecurityToJoin" sourceRef="recordSecurityFindings" targetRef="parallelAuditJoin"/>

        <intermediateCatchEvent id="securitySkipped" name="Security Skipped">
            <timerEventDefinition><timeDuration>PT0S</timeDuration></timerEventDefinition>
        </intermediateCatchEvent>

        <sequenceFlow id="flowSecuritySkipToJoin" sourceRef="securitySkipped" targetRef="parallelAuditJoin"/>

        <!-- ===== OPERATIONAL AUDIT STREAM ===== -->
        <exclusiveGateway id="checkOperationalRequired" name="Operational Audit Required?"/>

        <sequenceFlow id="flowOperationalYes" sourceRef="checkOperationalRequired" targetRef="operationalAudit">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresOperationalAudit == true}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowOperationalNo" sourceRef="checkOperationalRequired" targetRef="operationalSkipped">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresOperationalAudit == false}]]>
            </conditionExpression>
        </sequenceFlow>

        <userTask id="operationalAudit" name="Operational Compliance Audit"
                  flowable:candidateGroups="operations"
                  flowable:formKey="compliance-operational-form">
            <documentation>
                Conduct operational compliance audit.

                Areas to review:
                - Business continuity
                - Disaster recovery
                - Change management
                - Quality assurance
            </documentation>
        </userTask>

        <sequenceFlow id="flow6" sourceRef="operationalAudit" targetRef="recordOperationalFindings"/>

        <scriptTask id="recordOperationalFindings" name="Record Operational Findings"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var findings = JSON.parse(execution.getVariable('auditFindings') || '[]');
                var operationalFindings = execution.getVariable('operationalFindings') || '';
                var operationalRisk = parseInt(execution.getVariable('operationalRiskScore') || 0);

                if (operationalFindings) {
                    findings.push({
                        area: 'OPERATIONAL',
                        findings: operationalFindings,
                        riskScore: operationalRisk,
                        timestamp: new Date().toISOString()
                    });
                }

                var overallRisk = parseInt(execution.getVariable('overallRiskScore') || 0);
                execution.setVariable('overallRiskScore', overallRisk + operationalRisk);
                execution.setVariable('auditFindings', JSON.stringify(findings));
                execution.setVariable('operationalAuditComplete', true);
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flowOperationalToJoin" sourceRef="recordOperationalFindings" targetRef="parallelAuditJoin"/>

        <intermediateCatchEvent id="operationalSkipped" name="Operational Skipped">
            <timerEventDefinition><timeDuration>PT0S</timeDuration></timerEventDefinition>
        </intermediateCatchEvent>

        <sequenceFlow id="flowOperationalSkipToJoin" sourceRef="operationalSkipped" targetRef="parallelAuditJoin"/>

        <!-- ===== LEGAL AUDIT STREAM ===== -->
        <exclusiveGateway id="checkLegalRequired" name="Legal Audit Required?"/>

        <sequenceFlow id="flowLegalYes" sourceRef="checkLegalRequired" targetRef="legalAudit">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresLegalAudit == true}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowLegalNo" sourceRef="checkLegalRequired" targetRef="legalSkipped">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresLegalAudit == false}]]>
            </conditionExpression>
        </sequenceFlow>

        <userTask id="legalAudit" name="Legal Compliance Audit"
                  flowable:candidateGroups="legal"
                  flowable:formKey="compliance-legal-form">
            <documentation>
                Conduct legal/regulatory compliance audit.

                Areas to review:
                - Regulatory requirements
                - Contract compliance
                - Licensing
                - Data privacy (GDPR, CCPA)
            </documentation>
        </userTask>

        <sequenceFlow id="flow7" sourceRef="legalAudit" targetRef="recordLegalFindings"/>

        <scriptTask id="recordLegalFindings" name="Record Legal Findings"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var findings = JSON.parse(execution.getVariable('auditFindings') || '[]');
                var legalFindings = execution.getVariable('legalFindings') || '';
                var legalRisk = parseInt(execution.getVariable('legalRiskScore') || 0);

                if (legalFindings) {
                    findings.push({
                        area: 'LEGAL',
                        findings: legalFindings,
                        riskScore: legalRisk,
                        timestamp: new Date().toISOString()
                    });
                }

                var overallRisk = parseInt(execution.getVariable('overallRiskScore') || 0);
                execution.setVariable('overallRiskScore', overallRisk + legalRisk);
                execution.setVariable('auditFindings', JSON.stringify(findings));
                execution.setVariable('legalAuditComplete', true);
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flowLegalToJoin" sourceRef="recordLegalFindings" targetRef="parallelAuditJoin"/>

        <intermediateCatchEvent id="legalSkipped" name="Legal Skipped">
            <timerEventDefinition><timeDuration>PT0S</timeDuration></timerEventDefinition>
        </intermediateCatchEvent>

        <sequenceFlow id="flowLegalSkipToJoin" sourceRef="legalSkipped" targetRef="parallelAuditJoin"/>

        <!-- Parallel Gateway: Join All Audits -->
        <parallelGateway id="parallelAuditJoin" name="Consolidate Audit Results"/>

        <sequenceFlow id="flow8" sourceRef="parallelAuditJoin" targetRef="calculateRiskScore"/>

        <!-- Script Task: Calculate Overall Risk Score -->
        <scriptTask id="calculateRiskScore" name="Calculate Risk Score"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var findings = JSON.parse(execution.getVariable('auditFindings') || '[]');
                var criticalCount = 0;
                var totalFindings = findings.length;

                for (var i = 0; i < findings.length; i++) {
                    if (findings[i].riskScore >= 8) {
                        criticalCount++;
                    }
                }

                var overallRisk = parseInt(execution.getVariable('overallRiskScore') || 0);
                var riskLevel = 'LOW';
                if (overallRisk >= 30 || criticalCount >= 2) {
                    riskLevel = 'CRITICAL';
                } else if (overallRisk >= 20 || criticalCount >= 1) {
                    riskLevel = 'HIGH';
                } else if (overallRisk >= 10) {
                    riskLevel = 'MEDIUM';
                }

                execution.setVariable('riskLevel', riskLevel);
                execution.setVariable('findingsCount', totalFindings);
                execution.setVariable('criticalFindings', criticalCount);
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow9" sourceRef="calculateRiskScore" targetRef="checkCriticalFindings"/>

        <!-- Gateway: Check for Critical Findings -->
        <exclusiveGateway id="checkCriticalFindings" name="Critical Findings?"/>

        <sequenceFlow id="flowCritical" sourceRef="checkCriticalFindings" targetRef="developRemediationPlan">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${riskLevel == 'CRITICAL' || riskLevel == 'HIGH'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowNonCritical" sourceRef="checkCriticalFindings" targetRef="checkExternalAudit">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${riskLevel == 'MEDIUM' || riskLevel == 'LOW'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Develop Remediation Plan -->
        <userTask id="developRemediationPlan" name="Develop Remediation Plan"
                  flowable:candidateGroups="managers"
                  flowable:formKey="compliance-remediation-form">
            <documentation>
                CRITICAL/HIGH RISK FINDINGS REQUIRE REMEDIATION

                Risk Level: ${riskLevel}
                Total Findings: ${findingsCount}
                Critical: ${criticalFindings}

                Develop remediation plan for all findings.
            </documentation>
        </userTask>

        <sequenceFlow id="flow10" sourceRef="developRemediationPlan" targetRef="executeRemediation"/>

        <!-- User Task: Execute Remediation -->
        <userTask id="executeRemediation" name="Execute Remediation Actions"
                  flowable:candidateGroups="supervisors"
                  flowable:formKey="compliance-execute-remediation-form">
            <documentation>
                Execute remediation plan.
                Cycle: ${remediationCycles + 1}

                Complete all assigned remediation tasks.
            </documentation>
        </userTask>

        <sequenceFlow id="flow11" sourceRef="executeRemediation" targetRef="verifyRemediation"/>

        <!-- User Task: Verify Remediation -->
        <userTask id="verifyRemediation" name="Verify Remediation Effectiveness"
                  flowable:candidateGroups="managers"
                  flowable:formKey="compliance-verify-form">
            <documentation>
                Verify that remediation actions are effective.

                Actions: Confirm Complete, Partial, Failed
            </documentation>
        </userTask>

        <sequenceFlow id="flow12" sourceRef="verifyRemediation" targetRef="updateRemediationCycle"/>

        <!-- Script Task: Update Remediation Cycle -->
        <scriptTask id="updateRemediationCycle" name="Update Remediation Cycle"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var cycles = (execution.getVariable('remediationCycles') || 0) + 1;
                execution.setVariable('remediationCycles', cycles);
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow13" sourceRef="updateRemediationCycle" targetRef="checkRemediationStatus"/>

        <!-- Gateway: Check Remediation Status -->
        <exclusiveGateway id="checkRemediationStatus" name="Remediation Status"/>

        <sequenceFlow id="flowRemediationComplete" sourceRef="checkRemediationStatus" targetRef="checkExternalAudit">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowRemediationPartial" sourceRef="checkRemediationStatus" targetRef="checkRemediationCycles">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'request_changes'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowRemediationFailed" sourceRef="checkRemediationStatus" targetRef="escalateToExecutive">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Gateway: Check Remediation Cycles (Recursive Limit) -->
        <exclusiveGateway id="checkRemediationCycles" name="Max Cycles?"/>

        <sequenceFlow id="flowCanRetry" sourceRef="checkRemediationCycles" targetRef="executeRemediation">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${remediationCycles < 3}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowMaxCycles" sourceRef="checkRemediationCycles" targetRef="escalateToExecutive">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${remediationCycles >= 3}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Escalate to Executive -->
        <userTask id="escalateToExecutive" name="Executive Compliance Review"
                  flowable:candidateGroups="executives"
                  flowable:formKey="compliance-executive-form">
            <documentation>
                ESCALATION: Remediation has failed or exceeded cycles.

                Cycles: ${remediationCycles}
                Status: ${remediationStatus}

                Executive decision required.
            </documentation>
        </userTask>

        <sequenceFlow id="flow14" sourceRef="escalateToExecutive" targetRef="checkExecutiveDecision"/>

        <!-- Gateway: Check Executive Decision -->
        <exclusiveGateway id="checkExecutiveDecision" name="Executive Decision"/>

        <sequenceFlow id="flowAcceptRisk" sourceRef="checkExecutiveDecision" targetRef="documentRiskAcceptance">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowForceRemediation" sourceRef="checkExecutiveDecision" targetRef="executeRemediation">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'request_changes'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowExternalHelp" sourceRef="checkExecutiveDecision" targetRef="engageExternalConsultant">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Script Task: Document Risk Acceptance -->
        <scriptTask id="documentRiskAcceptance" name="Document Risk Acceptance"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                execution.setVariable('riskAccepted', true);
                execution.setVariable('riskAcceptedBy', execution.getVariable('executiveApprover'));
                execution.setVariable('riskAcceptedAt', new Date().toISOString());
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow15" sourceRef="documentRiskAcceptance" targetRef="checkExternalAudit"/>

        <!-- User Task: Engage External Consultant -->
        <userTask id="engageExternalConsultant" name="Engage External Consultant"
                  flowable:candidateGroups="legal"
                  flowable:formKey="compliance-external-consultant-form">
            <documentation>
                Engage external consultant for remediation assistance.
            </documentation>
        </userTask>

        <sequenceFlow id="flow16" sourceRef="engageExternalConsultant" targetRef="executeRemediation"/>

        <!-- Gateway: Check External Audit Required -->
        <exclusiveGateway id="checkExternalAudit" name="External Audit Required?"/>

        <sequenceFlow id="flowExternalRequired" sourceRef="checkExternalAudit" targetRef="externalAudit">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresExternalAudit == true}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowExternalNotRequired" sourceRef="checkExternalAudit" targetRef="prepareReport">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresExternalAudit == false}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: External Audit -->
        <userTask id="externalAudit" name="External Auditor Review"
                  flowable:candidateGroups="directors"
                  flowable:formKey="compliance-external-audit-form">
            <documentation>
                Coordinate external auditor review.
                Provide all documentation and facilitate access.
            </documentation>
        </userTask>

        <sequenceFlow id="flow17" sourceRef="externalAudit" targetRef="prepareReport"/>

        <!-- User Task: Prepare Final Report -->
        <userTask id="prepareReport" name="Prepare Compliance Report"
                  flowable:candidateGroups="legal"
                  flowable:formKey="compliance-report-form">
            <documentation>
                Prepare final compliance report.

                Risk Level: ${riskLevel}
                Findings: ${findingsCount}
                Remediation Cycles: ${remediationCycles}
            </documentation>
        </userTask>

        <sequenceFlow id="flow18" sourceRef="prepareReport" targetRef="boardCertification"/>

        <!-- User Task: Board Certification -->
        <userTask id="boardCertification" name="Board Compliance Certification"
                  flowable:candidateGroups="executives"
                  flowable:formKey="compliance-certification-form">
            <documentation>
                BOARD CERTIFICATION REQUIRED

                Review compliance report and certify.
            </documentation>
        </userTask>

        <sequenceFlow id="flow19" sourceRef="boardCertification" targetRef="finalizeCompliance"/>

        <!-- Script Task: Finalize -->
        <scriptTask id="finalizeCompliance" name="Finalize Compliance Review"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                execution.setVariable('status', 'COMPLETED');
                execution.setVariable('completedAt', new Date().toISOString());
                execution.setVariable('certificationNumber', 'COMP-' + new Date().getFullYear() + '-' + Math.floor(Math.random() * 10000));
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow20" sourceRef="finalizeCompliance" targetRef="endComplete"/>

        <!-- End Event -->
        <endEvent id="endComplete" name="Compliance Review Complete">
            <documentation>Compliance review has been completed and certified</documentation>
        </endEvent>

    </process>
</definitions>
